# NLP Service ะดะปั ะฐะฝะฐะปะธะทะฐ ะดะฝะตะฒะฝะธะบะพะฒัั ะทะฐะฟะธัะตะน

ะะตัะตัะผะธะฝะธัะพะฒะฐะฝะฝัะน, ัะฐััะธััะตะผัะน ะธ ัะตััะธััะตะผัะน ัะตัะฒะธั ะดะปั ะฐะฝะฐะปะธะทะฐ ัะตะบััะพะฒัั ะทะฐะฟะธัะตะน ั ะธะทะฒะปะตัะตะฝะธะตะผ ะบะฐัะตะณะพัะธะน, ะดะตะนััะฒะธะน, ะฒัะตะผะตะฝะธ ะธ ัะธะฟะพะฒ ะฐะบัะธะฒะฝะพััะตะน.

## ๐ฏ ะะพะทะผะพะถะฝะพััะธ

- **ะะฝะพะณะพััะพะฒะฝะตะฒัะน ะฟะฐััะธะฝะณ**: ะะพะผะฑะธะฝะฐัะธั ัะฒัะธััะธัะตัะบะธั ะฟัะฐะฒะธะป ะธ LLM-ะฐะฝะฐะปะธะทะฐ
- **ะฃะผะฝะฐั ะพัะตะฝะบะฐ ะฒัะตะผะตะฝะธ**: ะัะธะพัะธัะธะทะฐัะธั ะธััะพัะฝะธะบะพะฒ (ัะตะบัั โ ะธััะพัะธั โ ะผะพะดะตะปั โ ะดะตัะพะปั)
- **ะะตัะตะบัะธั ะดะพััะธะถะตะฝะธะน**: ะะฒัะพะผะฐัะธัะตัะบะพะต ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต ะทะฝะฐัะธะผัั ัะพะฑััะธะน
- **ะะตัะธัะพะฒะฐะฝะธะต**: Redis + in-memory ะดะปั ะพะฟัะธะผะธะทะฐัะธะธ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ
- **ะััะพัะธั ะดะตะนััะฒะธะน**: ะะฐะบะพะฟะปะตะฝะธะต ััะฐัะธััะธะบะธ ะดะปั ัะปัััะตะฝะธั ะพัะตะฝะพะบ
- **PII-ัะตะดะฐะบัะธัะพะฒะฐะฝะธะต**: ะะฒัะพะผะฐัะธัะตัะบะพะต ัะดะฐะปะตะฝะธะต ะฟะตััะพะฝะฐะปัะฝัั ะดะฐะฝะฝัั
- **ะกัััะบัััะธัะพะฒะฐะฝะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต**: JSON-ะปะพะณะธ ะดะปั observability
- **Prometheus-ะผะตััะธะบะธ**: ะะพะปะฝัะน ะผะพะฝะธัะพัะธะฝะณ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ ะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธั
- **ะขะธะฟะธะทะฐัะธั**: ะะพะปะฝะฐั ะฟะพะดะดะตัะถะบะฐ mypy ะดะปั ะฑะตะทะพะฟะฐัะฝะพััะธ ัะธะฟะพะฒ

## ๐ ะขัะตะฑะพะฒะฐะฝะธั

- Python 3.10+
- Redis (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะดะปั ะบะตัะธัะพะฒะฐะฝะธั)
- OpenAI API key (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะดะปั LLM-ะฟะฐััะธะฝะณะฐ)

## ๐ ะัััััะน ััะฐัั

### ะฃััะฐะฝะพะฒะบะฐ

```bash
# ะะปะพะฝะธัะพะฒะฐัั ัะตะฟะพะทะธัะพัะธะน
git clone <repo-url>
cd nlp_service

# ะฃััะฐะฝะพะฒะธัั ะทะฐะฒะธัะธะผะพััะธ
pip install -r requirements.txt

# ะะปะธ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ Poetry
poetry install

# ะะฐัััะพะธัั ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
cp .env.example .env
# ะััะตะดะฐะบัะธัะพะฒะฐัั .env ะธ ะดะพะฑะฐะฒะธัั OPENAI_API_KEY
```

### ะะฐะฟััะบ ั Docker

```bash
# ะกะฑะพัะบะฐ ะธ ะทะฐะฟััะบ
docker-compose up

# ะกะตัะฒะธั ะฑัะดะตั ะดะพัััะฟะตะฝ ะฝะฐ http://localhost:8000
```

### ะะพะบะฐะปัะฝัะน ะทะฐะฟััะบ

```bash
# ะะฐะฟัััะธัั Redis (ะตัะปะธ ะธัะฟะพะปัะทัะตััั ะบะตั)
redis-server

# ะะฐะฟัััะธัั ัะตัะฒะธั
uvicorn nlp_service.api.main:app --reload
```

## ๐ API ะะพะบัะผะตะฝัะฐัะธั

### Health Check

```bash
GET /health
```

**Response:**
```json
{
  "status": "ok",
  "version": "0.1.0"
}
```

### ะะฝะฐะปะธะท ัะตะบััะฐ

```bash
POST /api/v1/analyze
```

**Request:**
```json
{
  "user_id": 12345,
  "text": "ะกัะพะดะธะป ะฒ ะทะฐะป, ะฟะพะถะฐะป ัะพัะบั, ะฟัะธะณะพัะพะฒะธะป ะบััะพัะบั",
  "date": "2025-11-10"
}
```

**Response:**
```json
{
  "user_id": 12345,
  "date": "2025-11-10",
  "actions": [
    {
      "category": "ัะฟะพัั",
      "subcategory": null,
      "action": "ััะพะดะธะป ะฒ ะทะฐะป",
      "type": "activity",
      "estimated_time_minutes": 90,
      "time_source": "model",
      "confidence": 0.92,
      "achievement_weight": null,
      "points": 9.0
    },
    {
      "category": "ัะฟะพัั",
      "subcategory": "ะฑะพะดะธะฑะธะปะดะธะฝะณ",
      "action": "ะฟะพะถะฐะป ัะพัะบั",
      "type": "achievement",
      "estimated_time_minutes": 5,
      "time_source": "model",
      "confidence": 0.85,
      "achievement_weight": 15,
      "points": 15.0
    },
    {
      "category": "ะณะพัะพะฒะบะฐ",
      "subcategory": null,
      "action": "ะฟัะธะณะพัะพะฒะธะป ะบััะพัะบั",
      "type": "activity",
      "estimated_time_minutes": 40,
      "time_source": "model",
      "confidence": 0.9,
      "achievement_weight": null,
      "points": 4.0
    }
  ],
  "meta": {
    "used_heuristics": ["keyword_match", "time_extraction", "category_detection"],
    "used_llm": false,
    "llm_latency_ms": null,
    "heuristic_latency_ms": 120,
    "errors": []
  }
}
```

### ะกัะฐัะธััะธะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปั

```bash
GET /api/v1/stats/{user_id}
```

**Response:**
```json
{
  "user_id": 12345,
  "total_templates": 42,
  "total_actions": 156
}
```

### ะะตััะธะบะธ Prometheus

```bash
GET /metrics
```

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              FastAPI Application                โ
โ         (Logging, Metrics, DI Container)        โ
โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
โโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              Text Analyzer (Core)               โ
โ  - Orchestrates entire analysis pipeline        โ
โ  - Manages caching and history recording        โ
โโโโโฌโโโโโโโโโฌโโโโโโโโโฌโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
    โ        โ        โ        โ
โโโโโผโโโโโ โโโผโโโโโโโ โโโโโผโโโโโ โโโผโโโโโโโโโโ
โPreproc-โ โHeuristicโ โ  LLM   โ โ  Fusion   โ
โessor   โ โ Parser  โ โ Parser โ โ  Service  โ
โโโโโโโโโโ โโโโโโโโโโโ โโโโโโโโโโ โโโฌโโโโโโโโโโ
                                     โ
                    โโโโโโโโโโโโโโโโโโดโโโโโโโโโโโ
                    โ                           โ
            โโโโโโโโโผโโโโโโโโโ        โโโโโโโโโโผโโโโโโโ
            โ Postprocessor  โ        โ    History    โ
            โ   (Normalize,  โ        โ    Lookup     โ
            โ  Deduplicate)  โ        โ   Service     โ
            โโโโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโโ
```

### ะะพะผะฟะพะฝะตะฝัั

1. **Preprocessor**: ะัะธััะบะฐ ัะตะบััะฐ, PII-ัะตะดะฐะบัะธัะพะฒะฐะฝะธะต
2. **Heuristic Parser**: ะัััััะน ะฐะฝะฐะปะธะท ะฟะพ ะบะปััะตะฒัะผ ัะปะพะฒะฐะผ ะธ ัะตะณัะปััะฝัะผ ะฒััะฐะถะตะฝะธัะผ
3. **LLM Parser**: ะะปัะฑะพะบะธะน ะฐะฝะฐะปะธะท ัะตัะตะท OpenAI API
4. **Fusion Service**: ะะฑัะตะดะธะฝะตะฝะธะต ัะตะทัะปััะฐัะพะฒ ั ะฟัะธะพัะธัะธะทะฐัะธะตะน ะธััะพัะฝะธะบะพะฒ
5. **Postprocessor**: ะะพัะผะฐะปะธะทะฐัะธั ะธ ะดะตะดัะฟะปะธะบะฐัะธั
6. **History Service**: ะฅัะฐะฝะตะฝะธะต ะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั
7. **Cache Service**: ะะตัะธัะพะฒะฐะฝะธะต ัะตะทัะปััะฐัะพะฒ ะดะปั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะะฐะฟััะบ ัะตััะพะฒ

```bash
# ะัะต ัะตััั ั ะฟะพะบัััะธะตะผ
make test

# ะัััััะต ัะตััั (ะฑะตะท ะฟะพะบัััะธั)
make test-fast

# ะขะพะปัะบะพ unit-ัะตััั
pytest tests/test_*.py -v

# ะขะพะปัะบะพ ะธะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั
pytest tests/test_integration.py -v
```

### ะะพะบัััะธะต ะบะพะดะฐ

ะฆะตะปั: **โฅ80%** ะฟะพะบัััะธะต ะดะปั core-ะผะพะดัะปะตะน

```bash
pytest --cov=src/nlp_service --cov-report=html
# ะัะบัััั htmlcov/index.html ะฒ ะฑัะฐัะทะตัะต
```

## ๐ง ะะพะฝัะธะณััะฐัะธั

ะัะต ะฝะฐัััะพะนะบะธ ัะฟัะฐะฒะปััััั ัะตัะตะท ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะธะปะธ ัะฐะนะป `.env`:

| ะะตัะตะผะตะฝะฝะฐั | ะะฟะธัะฐะฝะธะต | ะะพ ัะผะพะปัะฐะฝะธั |
|------------|----------|--------------|
| `OPENAI_API_KEY` | API ะบะปัั OpenAI | - |
| `OPENAI_BASE_URL` | ะะฐะทะพะฒัะน URL ะดะปั OpenAI API | https://api.openai.com/v1 |
| `OPENAI_MODEL` | ะะพะดะตะปั OpenAI | gpt-4-turbo-preview |
| `REDIS_URL` | URL ะฟะพะดะบะปััะตะฝะธั ะบ Redis | redis://localhost:6379/0 |
| `CACHE_ENABLED` | ะะบะปััะธัั ะบะตัะธัะพะฒะฐะฝะธะต | true |
| `PII_REDACTION_ENABLED` | ะะบะปััะธัั ัะตะดะฐะบัะธัะพะฒะฐะฝะธะต PII | true |
| `DEFAULT_TIME_MINUTES` | ะะตัะพะปัะฝะพะต ะฒัะตะผั ะดะปั ะดะตะนััะฒะธะน | 10 |
| `HEURISTIC_CONFIDENCE_THRESHOLD` | ะะพัะพะณ ัะฒะตัะตะฝะฝะพััะธ ะดะปั ัะฒัะธััะธะบ | 0.8 |
| `LOG_LEVEL` | ะฃัะพะฒะตะฝั ะปะพะณะธัะพะฒะฐะฝะธั | INFO |

## ๐ ะะตััะธะบะธ ะธ ะผะพะฝะธัะพัะธะฝะณ

### ะะพัััะฟะฝัะต ะผะตััะธะบะธ

- `nlp_requests_total`: ะะฑัะตะต ะบะพะปะธัะตััะฒะพ ะทะฐะฟัะพัะพะฒ
- `nlp_requests_success_total`: ะฃัะฟะตัะฝัะต ะทะฐะฟัะพัั
- `nlp_requests_failed_total`: ะะตัะดะฐัะฝัะต ะทะฐะฟัะพัั
- `nlp_request_latency_seconds`: ะะฐัะตะฝัะฝะพััั ะทะฐะฟัะพัะพะฒ
- `nlp_llm_calls_total`: ะะพะปะธัะตััะฒะพ ะฒัะทะพะฒะพะฒ LLM
- `nlp_llm_latency_seconds`: ะะฐัะตะฝัะฝะพััั LLM
- `nlp_llm_tokens_used_total`: ะัะฟะพะปัะทะพะฒะฐะฝะฝัะต ัะพะบะตะฝั
- `nlp_actions_extracted`: ะะทะฒะปะตัะตะฝะฝัะต ะดะตะนััะฒะธั
- `nlp_cache_hits_total`: ะะพะฟะฐะดะฐะฝะธั ะฒ ะบะตั
- `nlp_cache_misses_total`: ะัะพะผะฐัะธ ะบะตัะฐ

### Grafana Dashboard

ะะผะฟะพััะธััะนัะต ะผะตััะธะบะธ Prometheus ะฒ Grafana ะดะปั ะฒะธะทัะฐะปะธะทะฐัะธะธ:
- ะะฐะฟัะพัั ะฒ ัะตะบัะฝะดั
- ะะฐัะตะฝัะฝะพััั (p50, p95, p99)
- ะงะฐััะพัะฐ ะพัะธะฑะพะบ
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต LLM ะธ ััะพะธะผะพััั
- ะญััะตะบัะธะฒะฝะพััั ะบะตัะฐ

## ๐ ะะตะทะพะฟะฐัะฝะพััั

### PII ะะตะดะฐะบัะธัะพะฒะฐะฝะธะต

ะะฒัะพะผะฐัะธัะตัะบะธ ัะตะดะฐะบัะธัััััั:
- Email ะฐะดัะตัะฐ โ `<EMAIL>`
- ะขะตะปะตัะพะฝะฝัะต ะฝะพะผะตัะฐ โ `<PHONE>`
- ะะพะผะตัะฐ ะฟะฐัะฟะพััะพะฒ โ `<PASSPORT>`
- ะะพะผะตัะฐ ะบะฐัั โ `<CARD>`
- ะะะ โ `<INN>`

### ะะพะณะธัะพะฒะฐะฝะธะต

- ะะพะปะฝัะน ัะตะบัั **ะฝะต ะปะพะณะธััะตััั** ะดะปั ะฟัะธะฒะฐัะฝะพััะธ
- ะขะพะปัะบะพ ัะตัะธัะพะฒะฐะฝะฝัะต ะบะปััะธ ะธ ะผะตัะฐะดะฐะฝะฝัะต
- ะกัััะบัััะธัะพะฒะฐะฝะฝัะต JSON ะปะพะณะธ

## ๐ ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### Python ะบะปะธะตะฝั

```python
import httpx
from datetime import date

async def analyze_diary_entry():
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "http://localhost:8000/api/v1/analyze",
            json={
                "user_id": 12345,
                "text": "ะกัะพะดะธะป ะฒ ะทะฐะป, ะฟะพะถะฐะป 100 ะบะณ, ัะธัะฐะป 2 ัะฐัะฐ",
                "date": str(date.today())
            }
        )
        result = response.json()
        
        for action in result["actions"]:
            print(f"{action['action']}: {action['points']} points")
```

### cURL

```bash
curl -X POST "http://localhost:8000/api/v1/analyze" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 12345,
    "text": "ะกัะพะดะธะป ะฒ ะทะฐะป, ะฟัะธะณะพัะพะฒะธะป ะพะฑะตะด",
    "date": "2025-11-10"
  }'
```

## ๐๏ธ ะะฐะทัะฐะฑะพัะบะฐ

### ะะธะฝัะธะฝะณ ะธ ัะพัะผะฐัะธัะพะฒะฐะฝะธะต

```bash
# ะะฒัะพะผะฐัะธัะตัะบะพะต ัะพัะผะฐัะธัะพะฒะฐะฝะธะต
make format

# ะัะพะฒะตัะบะฐ ะปะธะฝัะธะฝะณะฐ
make lint
```

### ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒัั ะบะฐัะตะณะพัะธะน

ะััะตะดะฐะบัะธััะนัะต `src/nlp_service/services/heuristic_parser.py`:

```python
def _build_category_keywords(self):
    return {
        "ะฝะพะฒะฐั_ะบะฐัะตะณะพัะธั": {
            "keywords": ["ะบะปัั1", "ะบะปัั2"],
            "subcategories": {
                "ะฟะพะดะบะฐัะตะณะพัะธั": ["ะฟะพะดะบะปัั1", "ะฟะพะดะบะปัั2"]
            }
        },
        # ...
    }
```

### ะะฐััะธัะตะฝะธะต LLM ะฟัะพะผะฟัะพะฒ

ะััะตะดะฐะบัะธััะนัะต `src/nlp_service/services/llm_parser.py`:
- ะะฑะฝะพะฒะธัะต `_build_system_prompt()` ะดะปั ะธะฝััััะบัะธะน
- ะะพะฑะฐะฒััะต ะฟัะธะผะตัั ะฒ `_build_examples()`

## ๐ Performance SLA

- **Heuristic parsing**: โค 2s
- **LLM parsing**: โค 6s (ะทะฐะฒะธัะธั ะพั API)
- **Total latency (p95)**: โค 6s
- **Uptime**: 99.5%
- **Error rate**: < 1%

## ๐ง Roadmap

- [ ] ะะพะดะดะตัะถะบะฐ ะผะฝะพะถะตััะฒะตะฝะฝัั LLM ะฟัะพะฒะฐะนะดะตัะพะฒ (Anthropic, local models)
- [ ] ะะตะบัะพัะฝะฐั ะฑะฐะทะฐ ะดะปั ัะตะผะฐะฝัะธัะตัะบะพะณะพ ะฟะพะธัะบะฐ
- [ ] Active Learning ะธะท ะฟะพะปัะทะพะฒะฐัะตะปััะบะธั ะธัะฟัะฐะฒะปะตะฝะธะน
- [ ] Fine-tuning ะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปััะบะธั ะดะฐะฝะฝัั
- [ ] GraphQL API
- [ ] Webhook notifications
- [ ] Multi-language support

## ๐ ะะธัะตะฝะทะธั

MIT License

## ๐ค Contributing

1. Fork the repository
2. Create a feature branch
3. Make changes with tests
4. Ensure linting passes: `make lint`
5. Ensure tests pass: `make test`
6. Submit a pull request

## ๐ง ะะพะฝัะฐะบัั

ะะปั ะฒะพะฟัะพัะพะฒ ะธ ะฟะพะดะดะตัะถะบะธ: [your-email@example.com]

---

**Built with โค๏ธ for productivity tracking**
